<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>FigTree Demo</title>
    <script src="./js/d3.js" charset="utf-8"></script>
    <!-- <script src="https://d3js.org/d3.v5.min.js" charset="utf-8"></script> -->
    <style>
      text {
        font-family: "helvetica-neue", "helvetica", "sans-serif";
        font-size: 14pt;
        font-weight: 300;
      }

      .branch-path {
        fill: none;
        stroke: #541753;
        stroke-width: 2px;
        stroke-linecap: round;
        stroke-linejoin: round;
      }

      .branch-path:hover {
        stroke-width: 4px;
      }

      .external-node.node-shape:not(.rough) {
        fill: #22b680;
        stroke: rgb(255, 255, 255);
        stroke-width: 1;
      }

      .external-node.node-shape:hover {
        stroke: rgb(0, 0, 0);
        /*stroke-width: 1;*/
      }

      .internal-node.node-shape {
        fill: #29c5ef;
        /*stroke: rgb(255, 255, 255);*/
        /*stroke-width: 1;*/
      }
      .internal-node.node-shape:hover {
        stroke: rgb(0, 0, 0);
      }

      .root.node-shape {
        fill: #e31e58;
        /*stroke: rgb(255, 255, 255);*/
        /*stroke-width: 1;*/
      }

      .node-background {
        fill: rgb(255, 255, 255);
        /*stroke: rgb(255, 255, 255);*/
        /*stroke-width: 1;*/
      }

      .node-label {
        font-family: "helvetica-neue", "helvetica", "sans-serif";
        font-size: 14pt;
        font-weight: 300;
      }

      .trend-line {
        stroke: rgb(0, 0, 0);
        stroke-width: 2px;
        stroke-linecap: round;
      }

      .axis text {
        font-family: "helvetica-neue", "helvetica", "sans-serif";
        font-size: 12pt;
        font-weight: 300;
      }

      .axis-label text {
        font-family: "helvetica-neue", "helvetica", "sans-serif";
        font-size: 12pt;
        font-weight: bold;
      }

      .node-label.support {
        font-size: 10pt;
      }

      .branch-label.length {
        display: none;
        font-size: 8pt;
      }

      #tooltip {
        background: #f6eeca;
        border: 1px solid #005c68;
        color: #005c68;
        border-radius: 5px;
        padding: 5px;
        font-family: "helvetica-neue", "helvetica", "sans-serif";
        font-size: 12pt;
        font-weight: 300;
      }
    </style>
  </head>

  <body>
    <div
      id="tooltip"
      display="none"
      style="position: absolute; display: none"
    ></div>

    <div>
      <figure>
        <svg id="phylogram_1a" width="600" height="500"></svg>
        <svg id="phylogram_1b" width="600" height="500"></svg>
      </figure>
      <button id="sort_up_button">Sort ascending</button>
      <button id="sort_down_button">Sort descending</button>
      <button id="rectangular_button">Draw rectangular</button>
      <button id="triangular_button">Draw triangular</button>
      <button id="toggle_tips_button">toggle tips</button>
      <button id="toggle_layout_button">toggle layout</button>
    </div>

    <script type="module">
      import { Tree } from "./dist/figtree.esm.js";

      const newickString =
        "((((((virus1:0.1,virus2:0.12)0.95:0.08,(virus3:0.011,virus4:0.0087)1.0:0.15)0.65:0.03,virus5:0.21)1.0:0.2,(virus6:0.45,virus7:0.4)0.51:0.02)1.0:0.1,virus8:0.4)1.0:0.1,(virus9:0.04,virus10:0.03)1.0:0.6);";

      const tree = Tree.parseNewick(newickString);
      tree.annotateNode(tree.root, { root: true });
      console.log(tree);
    </script>

    <script type="module">
      import {
        Tree,
        FigTree,
        rectangularLayout,
        transmissionLayout,
        polarLayout,
        circle,
        rectangle,
        branches,
        label,
      } from "./dist/figtree.esm.js";

      const newickString =
        "((((((virus1:0.1,virus2:0.12)0.95:0.08,(virus3:0.011,virus4:0.0087)1.0:0.15)0.65:0.03,virus5:0.21)1.0:0.2,(virus6:0.45,virus7:0.4)0.51:0.02)1.0:0.1,virus8:0.4)1.0:0.1,(virus9:0.04,virus10:0.03)1.0:0.6);";
      const tree = Tree.parseNewick(newickString);
      tree.annotateNode(tree.root, { root: true });
      const treeSVG = document.getElementById("phylogram_1a");
      const layout = rectangularLayout;
      const margins = { top: 10, bottom: 60, left: 10, right: 150 };
      //    const branchSettings = branch().hilightOnHover().collapseOnClick().curve(d3.curveStepBefore);
      let baseCurve = 0;
      const curvature = () => baseCurve;


      const circleTips = circle(tree.externalNodes, {
        attrs: {
          r: "7",
          // fill: "blue",
          // stroke: "red",
          // strokeWidth: 1
        },
      });
      const rectTips = rectangle(tree.externalNodes, {
        attrs: {
          width: "20",
          height: "20",
          // fill: "blue",
          // stroke: "red",
          // strokeWidth: 1
        },
      });

      let currentTips = "circle";
      let currentLayout = 0;
      const layouts = [rectangularLayout,transmissionLayout,polarLayout]
      const figTree = new FigTree({
        svg: treeSVG,
        margins,
        tree,
        layout: rectangularLayout,
        baubles: [
          circleTips,
          rectangle(tree.internalNodes, {
            attrs: {
              width: 10,
              height: 10,
              // fill:"green"
            },
            interactions: {
              click: (d) => {
                console.log(d);
                tree.rotate(d);
              },
            },
          }),
          label(tree.externalNodes, {
            //TODO move to node Shape
            text: (d) => d.name,
          }),
          branches(tree.nodes, {
            curvature: curvature,
            // attrs:{
            //     stroke:'black',
            //     strokeWidth:3
            // }
            interactions: {
              click: (d) => {
                console.log(d);
                tree.reroot(d);
              },
            },
          }),
        ],
      });

      figTree.addToolTip(
        ".internal-node.node-shape",
        "This is an internal node - it is the most recent<br>common ancestor of the viruses to the right.<br>Click the node to change the order of the descendents."
      );
      figTree.addToolTip(
        ".label",
        "This is a support value - it gives the degree<br>of statistical support that the viruses to the<br>right cluster together"
      );
      figTree.addToolTip(
        ".external-node.node-shape",
        "This is an external, leaf, or tip node - it represents<br>a sampled, sequenced virus"
      );
      figTree.addToolTip(
        ".branch-path",
        "This is a branch - it represents an<br>evolutionary lineage joining two nodes"
      );
      figTree.addToolTip(
        ".internal-node.root.node-shape",
        "The root node - represents the most recent<br>common ancestor of the whole tree"
      );

      document.getElementById("sort_up_button").onclick = function () {
        tree.orderByNodeDensity(false);
        // figTree.render();
      };
      document.getElementById("sort_down_button").onclick = function () {
        tree.orderByNodeDensity(true);
        // figTree.render();
      };
      document.getElementById("rectangular_button").onclick = function () {
        //    branchSettings.curve(d3.curveStepBefore);
        baseCurve = 0;
        figTree.render();
      };
      document.getElementById("triangular_button").onclick = function () {
        //    branchSettings.curve(d3.curveNatural);
        baseCurve = 1;
        figTree.render();
      };
      document.getElementById("toggle_tips_button").onclick = function () {
        if (currentTips === "circle") {
          figTree.replaceBauble(circleTips, rectTips);
          currentTips = "rectangle";
        } else {
          figTree.replaceBauble(rectTips, circleTips);
          currentTips = "circle";
          console.log("set to circle");
        }
      };
      document.getElementById("toggle_layout_button").onclick = function () {
        currentLayout+=1;
        figTree.layout(layouts[currentLayout%3])
      };
    </script>

    <script type="module">
      import {
        Tree,
        FigTree,
        rectangularLayout,
        circle,
        rectangle,
        roughCircle,
        branches,
        roughBranches,
        label,
      } from "./dist/figtree.esm.js";

      const newickString =
        "((((((virus1:0.1,virus2:0.12)0.95:0.08,(virus3:0.011,virus4:0.0087)1.0:0.15)0.65:0.03,virus5:0.21)1.0:0.2,(virus6:0.45,virus7:0.4)0.51:0.02)1.0:0.1,virus8:0.4)1.0:0.1,(virus9:0.04,virus10:0.03)1.0:0.6);";
      const tree = Tree.parseNewick(newickString);
      tree.annotateNode(tree.root, { root: true });
      const treeSVG = document.getElementById("phylogram_1b");
      const layout = rectangularLayout;
      const margins = { top: 10, bottom: 60, left: 10, right: 150 };
      //    const branchSettings = branch().hilightOnHover().collapseOnClick().curve(d3.curveStepBefore);
      let baseCurve = 0;
      const curvature = () => baseCurve;


      let currentTips = "circle";
      const figTree = new FigTree({
        svg: treeSVG,
        margins,
        tree,
        layout: rectangularLayout,
        baubles: [
          roughCircle(tree.externalNodes,{
            attrs:{
              r:30,
              fill:"blue"
            }
          }),
          roughBranches(tree.nodes, {
            curvature: 0.5,
            // attrs:{
            //     stroke:'black',
            //     strokeWidth:3
            // }
            interactions: {
              click: (d) => {
                console.log(d);
                tree.reroot(d);
              },
            },
          }),
        ],
      });

      //    layout.internalNodeLabels="probability";

      figTree.addToolTip(
        ".internal-node.node-shape",
        "This is an internal node - it is the most recent<br>common ancestor of the viruses to the right.<br>Click the node to change the order of the descendents."
      );
      figTree.addToolTip(
        ".label",
        "This is a support value - it gives the degree<br>of statistical support that the viruses to the<br>right cluster together"
      );
      figTree.addToolTip(
        ".external-node.node-shape",
        "This is an external, leaf, or tip node - it represents<br>a sampled, sequenced virus"
      );
      figTree.addToolTip(
        ".branch-path",
        "This is a branch - it represents an<br>evolutionary lineage joining two nodes"
      );
      figTree.addToolTip(
        ".internal-node.root.node-shape",
        "The root node - represents the most recent<br>common ancestor of the whole tree"
      );
    </script>
  </body>
</html>
