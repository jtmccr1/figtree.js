for(var e,t=[],n=0;n<256;++n)t.push((n+256).toString(16).slice(1));var r=new Uint8Array(16);function o(){if(!e&&!(e="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return e(r)}var i={randomUUID:"undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};function a(e,n,r){if(i.randomUUID&&!n&&!e)return i.randomUUID();var a=(e=e||{}).random||(e.rng||o)();if(a[6]=15&a[6]|64,a[8]=63&a[8]|128,n){r=r||0;for(var s=0;s<16;++s)n[r+s]=a[s];return n}return function(e,n=0){return(t[e[n+0]]+t[e[n+1]]+t[e[n+2]]+t[e[n+3]]+"-"+t[e[n+4]]+t[e[n+5]]+"-"+t[e[n+6]]+t[e[n+7]]+"-"+t[e[n+8]]+t[e[n+9]]+"-"+t[e[n+10]]+t[e[n+11]]+t[e[n+12]]+t[e[n+13]]+t[e[n+14]]+t[e[n+15]]).toLowerCase()}(a)}var s=new Date,l=new Date;function u(e,t,n,r){function o(t){return e(t=0===arguments.length?new Date:new Date(+t)),t}return o.floor=function(t){return e(t=new Date(+t)),t},o.ceil=function(n){return e(n=new Date(n-1)),t(n,1),e(n),n},o.round=function(e){var t=o(e),n=o.ceil(e);return e-t<n-e?t:n},o.offset=function(e,n){return t(e=new Date(+e),null==n?1:Math.floor(n)),e},o.range=function(n,r,i){var a,s=[];if(n=o.ceil(n),i=null==i?1:Math.floor(i),!(n<r&&i>0))return s;do{s.push(a=new Date(+n)),t(n,i),e(n)}while(a<n&&n<r);return s},o.filter=function(n){return u((function(t){if(t>=t)for(;e(t),!n(t);)t.setTime(t-1)}),(function(e,r){if(e>=e)if(r<0)for(;++r<=0;)for(;t(e,-1),!n(e););else for(;--r>=0;)for(;t(e,1),!n(e););}))},n&&(o.count=function(t,r){return s.setTime(+t),l.setTime(+r),e(s),e(l),Math.floor(n(s,l))},o.every=function(e){return e=Math.floor(e),isFinite(e)&&e>0?e>1?o.filter(r?function(t){return r(t)%e==0}:function(t){return o.count(0,t)%e==0}):o:null}),o}var h=864e5,c=6048e5,f=u((function(e){e.setHours(0,0,0,0)}),(function(e,t){e.setDate(e.getDate()+t)}),(function(e,t){return(t-e-6e4*(t.getTimezoneOffset()-e.getTimezoneOffset()))/h}),(function(e){return e.getDate()-1})),d=f;function g(e){return u((function(t){t.setDate(t.getDate()-(t.getDay()+7-e)%7),t.setHours(0,0,0,0)}),(function(e,t){e.setDate(e.getDate()+7*t)}),(function(e,t){return(t-e-6e4*(t.getTimezoneOffset()-e.getTimezoneOffset()))/c}))}f.range;var p=g(0),m=g(1),v=g(2),y=g(3),T=g(4),w=g(5),C=g(6);p.range,m.range,v.range,y.range,T.range,w.range,C.range;var b=u((function(e){e.setMonth(0,1),e.setHours(0,0,0,0)}),(function(e,t){e.setFullYear(e.getFullYear()+t)}),(function(e,t){return t.getFullYear()-e.getFullYear()}),(function(e){return e.getFullYear()}));b.every=function(e){return isFinite(e=Math.floor(e))&&e>0?u((function(t){t.setFullYear(Math.floor(t.getFullYear()/e)*e),t.setMonth(0,1),t.setHours(0,0,0,0)}),(function(t,n){t.setFullYear(t.getFullYear()+n*e)})):null};var U=b;b.range;var E=u((function(e){e.setUTCHours(0,0,0,0)}),(function(e,t){e.setUTCDate(e.getUTCDate()+t)}),(function(e,t){return(t-e)/h}),(function(e){return e.getUTCDate()-1})),_=E;function D(e){return u((function(t){t.setUTCDate(t.getUTCDate()-(t.getUTCDay()+7-e)%7),t.setUTCHours(0,0,0,0)}),(function(e,t){e.setUTCDate(e.getUTCDate()+7*t)}),(function(e,t){return(t-e)/c}))}E.range;var M=D(0),N=D(1),F=D(2),x=D(3),L=D(4),S=D(5),A=D(6);M.range,N.range,F.range,x.range,L.range,S.range,A.range;var I=u((function(e){e.setUTCMonth(0,1),e.setUTCHours(0,0,0,0)}),(function(e,t){e.setUTCFullYear(e.getUTCFullYear()+t)}),(function(e,t){return t.getUTCFullYear()-e.getUTCFullYear()}),(function(e){return e.getUTCFullYear()}));I.every=function(e){return isFinite(e=Math.floor(e))&&e>0?u((function(t){t.setUTCFullYear(Math.floor(t.getUTCFullYear()/e)*e),t.setUTCMonth(0,1),t.setUTCHours(0,0,0,0)}),(function(t,n){t.setUTCFullYear(t.getUTCFullYear()+n*e)})):null};var O=I;function Y(e){if(0<=e.y&&e.y<100){var t=new Date(-1,e.m,e.d,e.H,e.M,e.S,e.L);return t.setFullYear(e.y),t}return new Date(e.y,e.m,e.d,e.H,e.M,e.S,e.L)}function k(e){if(0<=e.y&&e.y<100){var t=new Date(Date.UTC(-1,e.m,e.d,e.H,e.M,e.S,e.L));return t.setUTCFullYear(e.y),t}return new Date(Date.UTC(e.y,e.m,e.d,e.H,e.M,e.S,e.L))}function R(e,t,n){return{y:e,m:t,d:n,H:0,M:0,S:0,L:0}}I.range;var H,$,B,W={"-":"",_:" ",0:"0"},j=/^\s*\d+/,K=/^%/,G=/[\\^$*+?|[\]().{}]/g;function V(e,t,n){var r=e<0?"-":"",o=(r?-e:e)+"",i=o.length;return r+(i<n?new Array(n-i+1).join(t)+o:o)}function Z(e){return e.replace(G,"\\$&")}function P(e){return new RegExp("^(?:"+e.map(Z).join("|")+")","i")}function J(e){for(var t={},n=-1,r=e.length;++n<r;)t[e[n].toLowerCase()]=n;return t}function q(e,t,n){var r=j.exec(t.slice(n,n+1));return r?(e.w=+r[0],n+r[0].length):-1}function X(e,t,n){var r=j.exec(t.slice(n,n+1));return r?(e.u=+r[0],n+r[0].length):-1}function z(e,t,n){var r=j.exec(t.slice(n,n+2));return r?(e.U=+r[0],n+r[0].length):-1}function Q(e,t,n){var r=j.exec(t.slice(n,n+2));return r?(e.V=+r[0],n+r[0].length):-1}function ee(e,t,n){var r=j.exec(t.slice(n,n+2));return r?(e.W=+r[0],n+r[0].length):-1}function te(e,t,n){var r=j.exec(t.slice(n,n+4));return r?(e.y=+r[0],n+r[0].length):-1}function ne(e,t,n){var r=j.exec(t.slice(n,n+2));return r?(e.y=+r[0]+(+r[0]>68?1900:2e3),n+r[0].length):-1}function re(e,t,n){var r=/^(Z)|([+-]\d\d)(?::?(\d\d))?/.exec(t.slice(n,n+6));return r?(e.Z=r[1]?0:-(r[2]+(r[3]||"00")),n+r[0].length):-1}function oe(e,t,n){var r=j.exec(t.slice(n,n+1));return r?(e.q=3*r[0]-3,n+r[0].length):-1}function ie(e,t,n){var r=j.exec(t.slice(n,n+2));return r?(e.m=r[0]-1,n+r[0].length):-1}function ae(e,t,n){var r=j.exec(t.slice(n,n+2));return r?(e.d=+r[0],n+r[0].length):-1}function se(e,t,n){var r=j.exec(t.slice(n,n+3));return r?(e.m=0,e.d=+r[0],n+r[0].length):-1}function le(e,t,n){var r=j.exec(t.slice(n,n+2));return r?(e.H=+r[0],n+r[0].length):-1}function ue(e,t,n){var r=j.exec(t.slice(n,n+2));return r?(e.M=+r[0],n+r[0].length):-1}function he(e,t,n){var r=j.exec(t.slice(n,n+2));return r?(e.S=+r[0],n+r[0].length):-1}function ce(e,t,n){var r=j.exec(t.slice(n,n+3));return r?(e.L=+r[0],n+r[0].length):-1}function fe(e,t,n){var r=j.exec(t.slice(n,n+6));return r?(e.L=Math.floor(r[0]/1e3),n+r[0].length):-1}function de(e,t,n){var r=K.exec(t.slice(n,n+1));return r?n+r[0].length:-1}function ge(e,t,n){var r=j.exec(t.slice(n));return r?(e.Q=+r[0],n+r[0].length):-1}function pe(e,t,n){var r=j.exec(t.slice(n));return r?(e.s=+r[0],n+r[0].length):-1}function me(e,t){return V(e.getDate(),t,2)}function ve(e,t){return V(e.getHours(),t,2)}function ye(e,t){return V(e.getHours()%12||12,t,2)}function Te(e,t){return V(1+d.count(U(e),e),t,3)}function we(e,t){return V(e.getMilliseconds(),t,3)}function Ce(e,t){return we(e,t)+"000"}function be(e,t){return V(e.getMonth()+1,t,2)}function Ue(e,t){return V(e.getMinutes(),t,2)}function Ee(e,t){return V(e.getSeconds(),t,2)}function _e(e){var t=e.getDay();return 0===t?7:t}function De(e,t){return V(p.count(U(e)-1,e),t,2)}function Me(e){var t=e.getDay();return t>=4||0===t?T(e):T.ceil(e)}function Ne(e,t){return e=Me(e),V(T.count(U(e),e)+(4===U(e).getDay()),t,2)}function Fe(e){return e.getDay()}function xe(e,t){return V(m.count(U(e)-1,e),t,2)}function Le(e,t){return V(e.getFullYear()%100,t,2)}function Se(e,t){return V((e=Me(e)).getFullYear()%100,t,2)}function Ae(e,t){return V(e.getFullYear()%1e4,t,4)}function Ie(e,t){var n=e.getDay();return V((e=n>=4||0===n?T(e):T.ceil(e)).getFullYear()%1e4,t,4)}function Oe(e){var t=e.getTimezoneOffset();return(t>0?"-":(t*=-1,"+"))+V(t/60|0,"0",2)+V(t%60,"0",2)}function Ye(e,t){return V(e.getUTCDate(),t,2)}function ke(e,t){return V(e.getUTCHours(),t,2)}function Re(e,t){return V(e.getUTCHours()%12||12,t,2)}function He(e,t){return V(1+_.count(O(e),e),t,3)}function $e(e,t){return V(e.getUTCMilliseconds(),t,3)}function Be(e,t){return $e(e,t)+"000"}function We(e,t){return V(e.getUTCMonth()+1,t,2)}function je(e,t){return V(e.getUTCMinutes(),t,2)}function Ke(e,t){return V(e.getUTCSeconds(),t,2)}function Ge(e){var t=e.getUTCDay();return 0===t?7:t}function Ve(e,t){return V(M.count(O(e)-1,e),t,2)}function Ze(e){var t=e.getUTCDay();return t>=4||0===t?L(e):L.ceil(e)}function Pe(e,t){return e=Ze(e),V(L.count(O(e),e)+(4===O(e).getUTCDay()),t,2)}function Je(e){return e.getUTCDay()}function qe(e,t){return V(N.count(O(e)-1,e),t,2)}function Xe(e,t){return V(e.getUTCFullYear()%100,t,2)}function ze(e,t){return V((e=Ze(e)).getUTCFullYear()%100,t,2)}function Qe(e,t){return V(e.getUTCFullYear()%1e4,t,4)}function et(e,t){var n=e.getUTCDay();return V((e=n>=4||0===n?L(e):L.ceil(e)).getUTCFullYear()%1e4,t,4)}function tt(){return"+0000"}function nt(){return"%"}function rt(e){return+e}function ot(e){return Math.floor(+e/1e3)}function it(e,t){let n,r=-1,o=-1;if(void 0===t)for(const t of e)++o,null!=t&&(n<t||void 0===n&&t>=t)&&(n=t,r=o);else for(let i of e)null!=(i=t(i,++o,e))&&(n<i||void 0===n&&i>=i)&&(n=i,r=o);return r}function at(e){const t=parseInt($("%Y")(e)),n=parseInt($("%j")(e)),r=function(e){return e%4==0&&e%100!=0||e%400==0}(t)?366:365;return t+n/r}H=function(e){var t=e.dateTime,n=e.date,r=e.time,o=e.periods,i=e.days,a=e.shortDays,s=e.months,l=e.shortMonths,u=P(o),h=J(o),c=P(i),f=J(i),g=P(a),p=J(a),v=P(s),y=J(s),T=P(l),w=J(l),C={a:function(e){return a[e.getDay()]},A:function(e){return i[e.getDay()]},b:function(e){return l[e.getMonth()]},B:function(e){return s[e.getMonth()]},c:null,d:me,e:me,f:Ce,g:Se,G:Ie,H:ve,I:ye,j:Te,L:we,m:be,M:Ue,p:function(e){return o[+(e.getHours()>=12)]},q:function(e){return 1+~~(e.getMonth()/3)},Q:rt,s:ot,S:Ee,u:_e,U:De,V:Ne,w:Fe,W:xe,x:null,X:null,y:Le,Y:Ae,Z:Oe,"%":nt},b={a:function(e){return a[e.getUTCDay()]},A:function(e){return i[e.getUTCDay()]},b:function(e){return l[e.getUTCMonth()]},B:function(e){return s[e.getUTCMonth()]},c:null,d:Ye,e:Ye,f:Be,g:ze,G:et,H:ke,I:Re,j:He,L:$e,m:We,M:je,p:function(e){return o[+(e.getUTCHours()>=12)]},q:function(e){return 1+~~(e.getUTCMonth()/3)},Q:rt,s:ot,S:Ke,u:Ge,U:Ve,V:Pe,w:Je,W:qe,x:null,X:null,y:Xe,Y:Qe,Z:tt,"%":nt},U={a:function(e,t,n){var r=g.exec(t.slice(n));return r?(e.w=p[r[0].toLowerCase()],n+r[0].length):-1},A:function(e,t,n){var r=c.exec(t.slice(n));return r?(e.w=f[r[0].toLowerCase()],n+r[0].length):-1},b:function(e,t,n){var r=T.exec(t.slice(n));return r?(e.m=w[r[0].toLowerCase()],n+r[0].length):-1},B:function(e,t,n){var r=v.exec(t.slice(n));return r?(e.m=y[r[0].toLowerCase()],n+r[0].length):-1},c:function(e,n,r){return M(e,t,n,r)},d:ae,e:ae,f:fe,g:ne,G:te,H:le,I:le,j:se,L:ce,m:ie,M:ue,p:function(e,t,n){var r=u.exec(t.slice(n));return r?(e.p=h[r[0].toLowerCase()],n+r[0].length):-1},q:oe,Q:ge,s:pe,S:he,u:X,U:z,V:Q,w:q,W:ee,x:function(e,t,r){return M(e,n,t,r)},X:function(e,t,n){return M(e,r,t,n)},y:ne,Y:te,Z:re,"%":de};function E(e,t){return function(n){var r,o,i,a=[],s=-1,l=0,u=e.length;for(n instanceof Date||(n=new Date(+n));++s<u;)37===e.charCodeAt(s)&&(a.push(e.slice(l,s)),null!=(o=W[r=e.charAt(++s)])?r=e.charAt(++s):o="e"===r?" ":"0",(i=t[r])&&(r=i(n,o)),a.push(r),l=s+1);return a.push(e.slice(l,s)),a.join("")}}function D(e,t){return function(n){var r,o,i=R(1900,void 0,1);if(M(i,e,n+="",0)!=n.length)return null;if("Q"in i)return new Date(i.Q);if("s"in i)return new Date(1e3*i.s+("L"in i?i.L:0));if(t&&!("Z"in i)&&(i.Z=0),"p"in i&&(i.H=i.H%12+12*i.p),void 0===i.m&&(i.m="q"in i?i.q:0),"V"in i){if(i.V<1||i.V>53)return null;"w"in i||(i.w=1),"Z"in i?(o=(r=k(R(i.y,0,1))).getUTCDay(),r=o>4||0===o?N.ceil(r):N(r),r=_.offset(r,7*(i.V-1)),i.y=r.getUTCFullYear(),i.m=r.getUTCMonth(),i.d=r.getUTCDate()+(i.w+6)%7):(o=(r=Y(R(i.y,0,1))).getDay(),r=o>4||0===o?m.ceil(r):m(r),r=d.offset(r,7*(i.V-1)),i.y=r.getFullYear(),i.m=r.getMonth(),i.d=r.getDate()+(i.w+6)%7)}else("W"in i||"U"in i)&&("w"in i||(i.w="u"in i?i.u%7:"W"in i?1:0),o="Z"in i?k(R(i.y,0,1)).getUTCDay():Y(R(i.y,0,1)).getDay(),i.m=0,i.d="W"in i?(i.w+6)%7+7*i.W-(o+5)%7:i.w+7*i.U-(o+6)%7);return"Z"in i?(i.H+=i.Z/100|0,i.M+=i.Z%100,k(i)):Y(i)}}function M(e,t,n,r){for(var o,i,a=0,s=t.length,l=n.length;a<s;){if(r>=l)return-1;if(37===(o=t.charCodeAt(a++))){if(o=t.charAt(a++),!(i=U[o in W?t.charAt(a++):o])||(r=i(e,n,r))<0)return-1}else if(o!=n.charCodeAt(r++))return-1}return r}return C.x=E(n,C),C.X=E(r,C),C.c=E(t,C),b.x=E(n,b),b.X=E(r,b),b.c=E(t,b),{format:function(e){var t=E(e+="",C);return t.toString=function(){return e},t},parse:function(e){var t=D(e+="",!1);return t.toString=function(){return e},t},utcFormat:function(e){var t=E(e+="",b);return t.toString=function(){return e},t},utcParse:function(e){var t=D(e+="",!0);return t.toString=function(){return e},t}}}({dateTime:"%x, %X",date:"%-m/%-d/%Y",time:"%-I:%M:%S %p",periods:["AM","PM"],days:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],shortDays:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],months:["January","February","March","April","May","June","July","August","September","October","November","December"],shortMonths:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"]}),$=H.format,B=H.parse,H.utcFormat,H.utcParse;const st={DISCRETE:Symbol("DISCRETE"),BOOLEAN:Symbol("BOOLEAN"),INTEGER:Symbol("INTEGER"),FLOAT:Symbol("FLOAT"),PROBABILITIES:Symbol("PROBABILITIES")};class lt{static DEFAULT_SETTINGS(){return{lengthsKnown:!0,heightsKnown:!1}}constructor(e=!1){this.heightsKnown=e,this.lengthsKnown=!e,this.annotations={},this._tipMap=new Map,this._nodeMap=new Map,this.nodesUpdated=!1,this._shouldUpdate=!0}treeUpdateCallback(){}get root(){return this._root}set root(e){this._root=e}get nodes(){return[...this.preorder()]}get nodeList(){return this.nodes}get externalNodes(){return this.nodes.filter((e=>!e.children))}get internalNodes(){return this.nodes.filter((e=>e.children))}get nodeMap(){return this._nodeMap}get tipMap(){return this._tipMap}getSibling(e){return e.parent?e.parent.children.find((t=>t!==e)):null}getNode(e){return this.nodeMap.get(e)}getExternalNode(e){return this.tipMap.get(e)}getHeight(e){return e.height}*preorder(e=this.root,t=(()=>!0)){const n=function*(e,t){if(t(e)&&(yield e,null!=e.children))for(const r of e.children)yield*n(r,t)};yield*n(e,t)}*postorder(e=this.root,t=(()=>!0)){const n=function*(e,t){if(t(e)){if(null!=e.children)for(const r of e.children)yield*n(r,t);yield e}};yield*n(e,t)}static*pathToRoot(e){for(;e;)yield e,e=e.parent}toNewick(e=this.root){return function e(t){return(t.children?`(${t.children.map((t=>e(t))).join(",")})${t.label?t.label:""}`:t.name)+(t.length?`:${t.length}`:"")}(e)+";"}reroot(e,t=.5){if(e===this.root)return;const n=this.root.children[0].length+this.root.children[1].length,r=e,o=e.parent,i=e.parent.children[0]===e;if(e.parent!==this.root){let a=e,s=e.parent,l=s.parent,u=s.length,h=!1;for(s.removeChild(a);!h;)if(l===this.root){const e=1===this.root.children.length?this.root.children[0]:this.getSibling(s);l.removeChild(e),l.removeChild(s),s.addChild(e),e._length=n,h=!0}else{let e=l.parent;l.removeChild(s),l.parent.removeChild(l),s.addChild(l);let t=l._length;l._length=u,u=t,a=s,s=l,l=e}i?(this.root.addChild(r),this.root.addChild(o)):(this.root.addChild(o),this.root.addChild(r)),this.internalNodes.forEach((e=>{e.children.forEach((t=>{t.parent=e}))}));const c=r.length*t;o._length=c,r._length=r.length-c}else{const r=e.length*(1-t);e._length=r,this.getSibling(e)._length=n-r}this.heightsKnown=!1,this.treeUpdateCallback()}rotate(e,t=!1){if(e.children){if(t)for(const n of e.children)this.rotate(n,t);e._children.reverse()}this.treeUpdateCallback()}orderByNodeDensity(e=!0,t=this.root){const n=e?1:-1;return ut.call(this,t,((e,t,r,o)=>(t-o)*n)),this.treeUpdateCallback(),this}order(e,t=this.root){return ut.call(this,t,e),this.treeUpdateCallback(),this}_order(e,t=this.root){return ut.call(this,t,e),this}lastCommonAncestor(e,t){const n=[...lt.pathToRoot(e)],r=[...lt.pathToRoot(t)],o=n.filter((e=>r.map((e=>e.id)).indexOf(e.id)>-1));return o[it(o,(e=>e.level))]}pathLength(e,t){let n=0;const r=this.lastCommonAncestor(e,t);for(let o of[e,t])for(;o!=r;)n+=o.length,o=o.parent;return n}subTree(e){const t=[...e.map((e=>[...lt.pathToRoot(e)]))].reduce(((e,t)=>[...e,...t]),[]).filter(((t,n,r)=>r.filter((e=>e===t)).length===e.length)).reduce(((e,t)=>(e.includes(t)||e.push(t),e)),[]),n=t[it(t,(e=>e.level))],r=new lt(n.toJS());return r.externalNodes.forEach((t=>{e.map((e=>e.id)).includes(t.id)||r.removeNode(t)})),r}rootToTipLength(e){let t=0;for(const n of lt.pathToRoot(e))n.length&&(t+=n.length);return t}rootToTipLengths(){return this.externalNodes.map((e=>this.rootToTipLength(e)))}splitBranches(e=null){[...this.preorder()].filter((e=>e.parent)).forEach((t=>{if(null!==e){if(e[t.id]){let n=t;e[t.id].forEach((([e,t])=>{n=this.splitBranch(n,e),n._id=t}))}}else this.splitBranch(t,.5)})),this.nodesUpdated=!0,this.treeUpdateCallback()}splitBranch(e,t=.5){const n=e.length,r=this.addNode({length:n*t,annotations:{insertedNode:!0}});return e.parent?(e.parent.addChild(r),e.parent.removeChild(e)):this.root=r,r.addChild(e),e._length=n-r.length,this.nodesUpdated=!0,this.heightsKnown=!1,r}removeNode(e){if(e===this.root)return;const t=e.parent;e.parent.removeChild(e),e.children?e.children.forEach((n=>{n._length+=e.length,n.parent=t,t.addChild(n)})):e.name&&this._tipMap.delete(e.name),this._nodeMap.delete(e._id),this.nodesUpdated=!0}addNode(e={},t=!1){const n=new dt({...e,tree:this});if(this._nodeMap.set(n.id,n),t){if(null===n.name)throw new Error("tips need names");if(this._tipMap.has(n.name))throw new Error("${node.name} already in tree");this._tipMap.set(n.name,n)}return n}removeClade(e){if(e!==this.root){for(const t of this.postorder(e))this.removeNode(t);return this.nodesUpdated=!0,this.treeUpdateCallback(),this}}annotateTips(e){for(let[t,n]of Object.entries(e)){const e=this.getExternalNode(t);if(!e)throw new Error(`tip with label ${t} not found in tree`);this.annotateNode(e,n)}this.treeUpdateCallback()}annotateNodes(e){for(let[t,n]of Object.entries(e)){const e=this.getNode(t);if(!e)throw new Error(`tip with key ${t} not found in tree`);this.annotateNode(e,n)}this.treeUpdateCallback()}annotateNode(e,t){this._addAnnotations(t),e._annotations={...void 0===e.annotations?{}:e.annotations,...t}}_addAnnotations(e){for(let[t,n]of Object.entries(e)){let e=this.annotations[t];if(e||(e={},this.annotations[t]=e),Array.isArray(n)){let r;if(n.map((e=>isNaN(e))).reduce(((e,t)=>e&&t),!0)?(r=st.DISCRETE,e.type=r,e.values||(e.values=new Set),e.values.add(...n)):n.map((e=>parseFloat(e))).reduce(((e,t)=>e&&Number.isInteger(t)),!0)?r=st.INTEGER:n.map((e=>parseFloat(e))).reduce(((e,t)=>e&&!Number.isInteger(t)),!0)&&(r=st.FLOAT),e.type&&e.type!==r&&(r===st.INTEGER&&e.type===st.FLOAT||r===st.FLOAT&&e.type===st.INTEGER)){if(r=st.FLOAT,e.type=st.FLOAT,!e.values)throw Error(`existing values of the annotation, ${t}, in the tree is discrete.`);delete e.values}}else if(Object.isExtensible(n)){let r=null,o=0,i=[];for(let[e,t]of Object.entries(n)){if(i.includes(e))throw Error(`the states of annotation, ${e}, should be unique`);if("number"==typeof t){if(r=void 0===r?st.PROBABILITIES:r,r===st.DISCRETE)throw Error(`the values of annotation, ${e}, should be all boolean or all floats`);if(o+=t,o>1.01)throw Error(`the values of annotation, ${e}, should be probabilities of states and add to 1.0`)}else{if("boolean"!=typeof t)throw Error(`the values of annotation, ${e}, should be all boolean or all floats`);if(r=void 0===r?st.DISCRETE:r,r===st.PROBABILITIES)throw Error(`the values of annotation, ${e}, should be all boolean or all floats`)}i.push(e)}if(e.type&&e.type!==r)throw Error(`existing values of the annotation, ${t}, in the tree is not of the same type`);e.type=r,e.values=e.values?[...e.values,n]:[n]}else{let r=st.DISCRETE;if("boolean"==typeof n?r=st.BOOLEAN:isNaN(n)||(r=n%1==0?st.INTEGER:st.FLOAT),e.type&&e.type!==r){if(!(r===st.INTEGER&&e.type===st.FLOAT||r===st.FLOAT&&e.type===st.INTEGER))throw Error(`existing values of the annotation, ${t}, in the tree is not of the same type`);r=st.FLOAT}r===st.DISCRETE&&(e.values||(e.values=new Set),e.values.add(n)),e.type=r}this.annotations[t]=e}}annotateNodesFromTips(e,t=!0){ct(e,this.root),ft(e,[],t,this.root),this.treeUpdateCallback()}subscribeCallback(e){const t=this.treeUpdateCallback;this.treeUpdateCallback=()=>{this._shouldUpdate&&(t(),e())}}getClades(e=null){return this.nodeList.filter((e=>e.parent)).map((t=>t.getClade(e)))}batchUpdateOn(){this._shouldUpdate=!1}batchUpdateOff(){this._shouldUpdate=!0,this.treeUpdateCallback()}static parseNewick(e,t={}){t={labelName:"label",datePrefix:void 0,dateFormat:"decimal",tipNameMap:null,...t};const n=e.split(/\s*('[^']+'|"[^"]+"|;|\(|\)|,|:|=|\[&|\]|\{|\})\s*/);let r,o=0,i=null,a=[],s=!1,l=!1,u=!1,h=!0,c=!1,f={};const d=new lt;for(const e of n.filter((e=>e.length>0)))if(u)if("="===e)h=!1;else if(","===e)c||(h=!0);else if("{"===e)c=!0,f[r]=[];else if("}"===e)c=!1;else if("]"===e)u=!1,h=!0,d.annotateNode(i,f),f={};else{let t=e;(t.startsWith('"')||t.startsWith("'"))&&(t=t.substr(1)),(t.endsWith('"')||t.endsWith("'"))&&(t=t.substr(0,t.length-1)),h?r=t.replace(".","_"):c?f[r].push(t):isNaN(t)?f[r]=t:f[r]=parseFloat(t)}else if("("===e){if(s)throw new Error("expecting a comma");let e=d.addNode();o+=1,i?a.push(i):d.root=e,i=e}else if(","===e){if(s=!1,l)throw new Error("branch length missing");let e=a.pop();e.addChild(i),i.parent=e,i=e}else if(")"===e){if(s=!1,l)throw new Error("branch length missing");let e=a.pop();if(void 0===e)throw new Error("the brackets in the newick file are not balanced: too many closed");e.addChild(i),i.parent=e,o-=1,i=e,s=!0}else if(":"===e)s=!1,l=!0;else{if(";"===e){if(o>0)throw new Error("the brackets in the newick file are not balanced: too many opened");break}if("[&"===e)u=!0;else if(l)i.length=parseFloat(e),l=!1;else if(s){if(i.label=e,!i.label.startsWith("#")){let e=parseFloat(i.label);isNaN(e)&&(e=i.label);let n={};n[t.labelName]=e,d.annotateNode(i,n)}s=!1}else{let n,r,o=t.tipNameMap?t.tipNameMap.get(e):e;if((o.startsWith('"')||o.startsWith("'"))&&(o=o.substr(1)),(o.endsWith('"')||o.endsWith("'"))&&(o=o.substr(0,o.length-1)),o=o.trim(),t.datePrefix){const e=o.split(t.datePrefix);if(0===e.length)throw new Error(`the tip, ${o}, doesn't have a date separated by the prefix, '${t.datePrefix}'`);const i=e[e.length-1];"decimal"===t.dateFormat?n=parseFloat(e[e.length-1]):(r=B(t.dateFormat)(i),r||(r=B(t.dateFormat)(`${i}-15`)),r||(r=B(t.dateFormat)(`${i}-06-15`)),n=at(r))}const s=d.addNode({name:o.replace(/\'/g,"")},!0);null!==n&&d.annotateNode(s,{date:n}),i&&a.push(i),i=s}}if(o>0)throw new Error("the brackets in the newick file are not balanced");return d}static parseNexus(e,t={}){const n=[],r=e.split(/\s*(?:\bBegin\s+|\bbegin\s+|\bBEGIN\s+|\bend\s*;|\bEnd\s*;|\bEND\s*;)\s*/).filter((e=>""!==e));if("#nexus"!==r.shift().trim().toLowerCase())throw Error("File does not begin with #NEXUS is it a nexus file?");for(const e of r){const r=e.replace(/^\s+|\s+$/g,"").split(/\n/);if("trees;"===r.shift().toLowerCase().trim()){let e=!1;const o=new Map;for(const i of r)if("translate"===i.trim().toLowerCase())e=!0;else if(e)if(";"===i.trim())e=!1;else{const e=i.trim().replace(",","").split(/\s*\s\s*/);o.set(e[0],e[1])}else{const e=i.substring(i.indexOf("("));if(o.size>0){const r=lt.parseNewick(e,{...t,tipNameMap:o});n.push(r)}else{const r=lt.parseNewick(e,{...t});n.push(r)}}}}return n}}function ut(e,t,n=null){let r=0;if(e.children){const o=new Map;for(const i of e.children){const e=ut(i,t,n);o.set(i.id,e),r+=e}e._children.sort(((n,r)=>t(n,o.get(n),r,o.get(r),e))),n&&n()}else r=1;return r}function ht(e){e.nodeList.forEach((e=>e._length=e.parent?e.parent.height-e.height:0)),e.lengthsKnown=!0,e.heightsKnown=!1}function ct(e,t){if(!t.children)return t.annotations[e]?Array.isArray(t.annotations[e])?t.annotations[e]:[t.annotations[e]]:[];let n,r=[];return t.children.forEach((t=>{const o=ct(e,t);r=[...r,...o.filter((e=>!r.includes(e)))],n=void 0===n?o:o.filter((e=>n.includes(e)))})),this.annotateNode(t,{[e]:[...n.length>0?n:r]}),t.annotations[e]}function ft(e,t,n,r){let o=r.annotations[e];if(Array.isArray(o)||(o=[o]),r.children){let i={};o.forEach((e=>i[e]=i[e]?i[e]+=1:1)),t.forEach((e=>i[e]=i[e]?i[e]+=1:1)),r.children.forEach((t=>{ft(e,o,n,t).forEach((e=>i[e]=i[e]?i[e]+=1:1))}));const a=Object.entries(i).reduce(((e,t)=>e[1]>t[1]?e:t))[1];o=Object.entries(i).filter((([e,t])=>t===a)).map((([e,t])=>e)),r.annotations[e]=1===o.length?o[0]:o}return o}class dt{static DEFAULT_NODE(){return{height:void 0,divergence:void 0,length:void 0,name:null,annotations:{},parent:void 0,children:null,label:void 0}}constructor(e={}){const t={...dt.DEFAULT_NODE(),...e};this._id=` node-${a()}`,this._height=t.height,this._length=t.length,this._name=t.name,this._annotations=t.annotations,this._parent=t.parent,this._children=t.children,this._tree=t.tree,this._label=t.label}get level(){let e=0,t=this;for(;t.parent;)t=t.parent,e+=1;return e}get name(){return this._name}set name(e){this._tree.nodesUpdated=!0,this._name=e}get label(){return this._label}set label(e){this._label=e}get height(){return this._tree.heightsKnown||function(e){const t=function(e,t){let n;if(void 0===t)for(const t of e)null!=t&&(n<t||void 0===n&&t>=t)&&(n=t);else{let r=-1;for(let o of e)null!=(o=t(o,++r,e))&&(n<o||void 0===n&&o>=o)&&(n=o)}return n}(e.rootToTipLengths());e.nodeList.forEach((n=>n._height=t-e.rootToTipLength(n))),e.heightsKnown=!0,e.lengthsKnown=!1}(this._tree),this._height}get divergence(){return this._tree.lengthsKnown?this.parent?this.parent.divergence+this.length:0:(ht(this._tree),this.divergence)}set height(e){this._height=e,this._tree.lengthsKnown=!1}get length(){return this._tree.lengthsKnown||ht.call(this._tree),this._length}set length(e){this._tree.lengthsKnown||ht.call(this._tree),this._length=e}get annotations(){return{...this._annotations}}set annotations(e){throw new Error("node annotations can not be set this way. The tree needs to know about annotation types. Use tree.annotateNode to set annotations")}get children(){return null===this._children?null:this._children.map((e=>this._tree.getNode(e)))}removeChild(e){this._children=this._children.filter((t=>t!==e.id)),e._parent=null}addChild(e){null===this._children&&(this._children=[]),this._children.push(e.id),e.parent=this}get parent(){return this._tree.getNode(this._parent)}set parent(e){this._parent=e.id}get id(){return this._id}get tree(){return this._tree}getClade(e=null){if(null==e&&this.clade&&!1===this._tree.nodesUpdated)return this._clade;let t=[];if(this.children){for(const n of this.children)t=t.concat(n.getClade(e));this._clade=t}else{const n=e?e.get(this.name):this.id;if(n!==parseInt(n))throw new Error("Getting clade requires tips have integer id's. If they do not please provide a map to integers keyed by the tips' names ");t=t.concat(this.id),this._clade=t}return t}toJS(){return{name:this.name,length:this.length,height:this.height,label:this.label,level:this.level,annotations:this.annotations,children:this.children&&this.children.length>0?this.children.map((e=>e.toJS())):null}}}export{lt as Tree};
//# sourceMappingURL=figtree.esm.js.map
